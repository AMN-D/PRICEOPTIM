{% extends 'base.html' %}
{% load static %}
{% block start %}
<div class="body-your-main">
    <div class="body-your-main-scroll"></div>
    <div class="body-your-inside">
        <div class="body-your-inside-text-container">
                <div class="body-your-inside-text">
                    <h1>PICK</h1>
                    <h1>MODEL</h1>
                </div>
                <div class="body-your-inside-desc">
                    <p>WORKING ?</p>
                </div>
                <div class="body-your-inside-desc-detail">
                    <p>Select your model, peek at the CSV preview, pick optimization features, input product details, and watch your optimization results unfold!</p>
                </div>
                <div class="body-your-inside-model-selector">
                    <select id="selectOption">
                        <option value="0">---</option>
                        <option value="1">LOWKEY</option>
                    </select>
                </div>
                <div class="body-your-inside-design">
                    <p>091</p>
                </div>
            </div>
            <div class="body-your-inside-csv-container">
                <table id="csv-table"></table>
                <p>CSV</p>
            </div>
        </div>
    </div>
    <div class="body-your-feature">
        <div class="body-your-feature-inside">
            <div class="body-your-feature-input">
                <div class="body-your-feature-input-main" id="feature-input-container"></div>
                <div class="body-your-feature-input-main-eval">
                    <button class="custom-button">Evaluate</button>
                </div>
                <div class="body-your-feature-design">
                    <h1>YOU</h1>
                </div>
            </div>
            <div class="body-your-feature-selector">
                <div class="body-your-feature-checkbox" id="feature-checkbox-div"></div>
                <div class="body-your-feature-outcome" id="outcome-div"></div>
            </div>
        </div>
    </div>
</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        var selectElement = document.getElementById('selectOption');
        var outcomeDiv = document.getElementById('outcome-div');
        var featureCheckboxDiv = document.getElementById('feature-checkbox-div');
        var inputContainerDiv = document.getElementById('feature-input-container');
        var containerDiv = document.querySelector('.body-your-inside-csv-container');
        var features = {{ features|safe }};
        var selectedFeatures = [];

        function generateInputFields(selectedFeatures) {
            inputContainerDiv.innerHTML = '';

            selectedFeatures.forEach(function(feature) {
                var input = document.createElement('input');
                input.type = 'text';
                input.placeholder = feature.toUpperCase().replace('_', ' ');

                inputContainerDiv.appendChild(input);
            });
        }

        function createFeatureCheckbox(feature) {
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = feature;
            checkbox.id = feature;

            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedFeatures.push(this.value);
                } else {

                function createFeatureCheckbox(feature) {
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = feature;
                    checkbox.id = feature;

                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedFeatures.push(this.value);
                        } else {
                            selectedFeatures = selectedFeatures.filter(function(item) {
                                return item !== this.value;
                            }.bind(this)); 
                            removeInputFields(this.value);
                        }
                        generateInputFields(selectedFeatures);
                    });

                    var label = document.createElement('label');
                    label.htmlFor = feature;
                    label.appendChild(document.createTextNode(feature));

                    featureCheckboxDiv.appendChild(checkbox);
                    featureCheckboxDiv.appendChild(label);
                    featureCheckboxDiv.appendChild(document.createElement('br'));
                }
                        selectedFeatures = selectedFeatures.filter(function(item) {
                            return item !== this.value;
                        }.bind(this)); 
                        removeInputFields(this.value);
                    }
                generateInputFields(selectedFeatures);
            });

            var label = document.createElement('label');
            label.htmlFor = feature;
            label.appendChild(document.createTextNode(feature));
            featureCheckboxDiv.appendChild(checkbox);
            featureCheckboxDiv.appendChild(label);
            featureCheckboxDiv.appendChild(document.createElement('br'));
        }

        function removeInputFields(feature) {
            var inputs = inputContainerDiv.querySelectorAll('input');
            inputs.forEach(function(input) {
                if (input.placeholder.toLowerCase().includes(feature.toLowerCase())) {
                    input.remove();
                }
            });
        }

        selectElement.addEventListener('change', function () {
            if (selectElement.value === '1') {
                var outcome = "{{ outcome }}";
                outcomeDiv.innerHTML = outcome;
                featureCheckboxDiv.innerHTML = '';
                features.forEach(function(feature) {
                    createFeatureCheckbox(feature);
                });
                var jsonData = JSON.parse('{{ json_data|escapejs }}');
                var table = '<table border="1">';
                table += '<tr>';
                for (var key in jsonData[0]) {
                    table += '<th>' + key + '</th>';
                }
                table += '</tr>';
                for (var i = 0; i < jsonData.length; i++) {
                    table += '<tr>';
                    for (var key in jsonData[i]) {
                        table += '<td>' + jsonData[i][key] + '</td>';
                    }
                    table += '</tr>';
                }
                table += '</table>';
                containerDiv.innerHTML = table;
            } else if (selectElement.value === '0') {
                outcomeDiv.innerHTML = '';
                inputContainerDiv.innerHTML = '';
                featureCheckboxDiv.innerHTML = '';
                containerDiv.innerHTML = '';
            } else {
                console.log('Select a value');
            }
        });
    });

</script>

{% endblock %}
{% block footer %}
{% endblock %}
